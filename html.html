<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>لعبة XO أونلاين</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCflw5LIGASb8ne8dXspJDwXQeubpmc0x4",
      authDomain: "xo-xo-d0335.firebaseapp.com",
      projectId: "xo-xo-d0335",
      storageBucket: "xo-xo-d0335.appspot.com",
      messagingSenderId: "526412538853",
      appId: "1:526412538853:web:32599656e9c8d6922cc50c",
      databaseURL: "https://xo-xo-d0335-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let playerName = "";
    let opponentName = "";
    let roomId = "";
    let symbol = "";
    let isMyTurn = false;
    let winCounts = { X: 0, O: 0 };

    const gameBoard = document.getElementById("game-board");
    const statusText = document.getElementById("status");
    const createForm = document.getElementById("create-form");
    const joinForm = document.getElementById("join-form");
    const roomSection = document.getElementById("room-section");
    const boardSection = document.getElementById("board-section");
    const roomIdDisplay = document.getElementById("room-id-display");
    const chatBox = document.getElementById("chat-box");
    const chatMessages = document.getElementById("messages");

    function playSound(src) {
      const sound = new Audio(src);
      sound.play();
    }

    function createBoard() {
      gameBoard.innerHTML = "";
      for (let i = 0; i < 9; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.index = i;
        cell.onclick = () => makeMove(i);
        gameBoard.appendChild(cell);
      }
    }

    function makeMove(index) {
      if (!isMyTurn) return;
      const cell = document.querySelector(`[data-index='${index}']`);
      if (cell.textContent !== "") return;
      set(ref(db, `rooms/${roomId}/board/${index}`), symbol);
      set(ref(db, `rooms/${roomId}/turn`), symbol === "X" ? "O" : "X");
      playSound("click.mp3");
    }

    function checkWinner(board) {
      const winPatterns = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (let pattern of winPatterns) {
        const [a,b,c] = pattern;
        if (board[a] && board[a] === board[b] && board[a] === board[c]) {
          return board[a];
        }
      }
      if (board.every(cell => cell)) return "تعادل";
      return null;
    }

    function updateBoard(board) {
      const cells = document.querySelectorAll(".cell");
      board.forEach((value, i) => {
        cells[i].textContent = value || "";
      });
    }

    function resetRoom() {
      set(ref(db, `rooms/${roomId}`), {
        board: Array(9).fill(null),
        turn: "X",
        players: { X: playerName, O: opponentName },
        chat: []
      });
    }

    function leaveRoom() {
      location.reload();
    }

    function sendMessage() {
      const input = document.getElementById("chat-input");
      const text = input.value.trim();
      if (!text) return;
      push(ref(db, `rooms/${roomId}/chat`), { name: playerName, text });
      input.value = "";
    }

    createForm.onsubmit = e => {
      e.preventDefault();
      const name = document.getElementById("player-name").value.trim();
      const opponent = document.getElementById("opponent-name").value.trim();
      playerName = name;
      opponentName = opponent;
      symbol = "X";
      isMyTurn = true;
      roomId = Math.random().toString(36).substr(2, 6);
      roomIdDisplay.textContent = `معرف الغرفة: ${roomId}`;
      roomSection.style.display = "none";
      boardSection.style.display = "block";
      createBoard();
      resetRoom();
    };

    joinForm.onsubmit = e => {
      e.preventDefault();
      roomId = document.getElementById("join-room-id").value.trim();
      playerName = document.getElementById("join-name").value.trim();
      symbol = "O";
      isMyTurn = false;
      roomIdDisplay.textContent = `معرف الغرفة: ${roomId}`;
      roomSection.style.display = "none";
      boardSection.style.display = "block";
      createBoard();
    };

    function listenForChanges() {
      onValue(ref(db, `rooms/${roomId}/board`), snapshot => {
        const board = snapshot.val();
        if (!board) return;
        updateBoard(board);
        const winner = checkWinner(board);
        if (winner) {
          if (winner === "تعادل") {
            alert("انتهت المباراة بتعادل!");
          } else {
            alert(`فاز ${winner === symbol ? "أنت" : "خصمك"}!`);
            winCounts[winner]++;
            document.getElementById("score-X").textContent = winCounts["X"];
            document.getElementById("score-O").textContent = winCounts["O"];
            playSound("win.mp3");
          }
          resetRoom();
        }
      });

      onValue(ref(db, `rooms/${roomId}/turn`), snapshot => {
        const turn = snapshot.val();
        isMyTurn = (turn === symbol);
        statusText.textContent = isMyTurn ? "دورك الآن" : "انتظر خصمك...";
      });

      onValue(ref(db, `rooms/${roomId}/chat`), snapshot => {
        const data = snapshot.val();
        chatMessages.innerHTML = "";
        if (data) {
          Object.values(data).forEach(msg => {
            const div = document.createElement("div");
            div.textContent = `${msg.name}: ${msg.text}`;
            chatMessages.appendChild(div);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      });
    }

    setInterval(() => {
      if (roomId) listenForChanges();
    }, 1000);
  </script>
  <style>
    body { font-family: Arial; text-align: center; background: #f0f0f0; }
    .cell {
      width: 60px; height: 60px; display: inline-block;
      border: 1px solid #000; font-size: 2em; line-height: 60px;
      cursor: pointer; background: white;
    }
    #game-board { width: 180px; margin: 20px auto; display: flex; flex-wrap: wrap; }
    #room-section, #board-section { margin: 20px; }
    #board-section { display: none; }
    #chat-box { margin-top: 20px; max-width: 300px; margin-inline: auto; background: white; padding: 10px; border-radius: 8px; }
    #messages { height: 150px; overflow-y: scroll; border: 1px solid #ccc; margin-bottom: 10px; text-align: left; padding: 5px; background: #f9f9f9; }
  </style>
</head>
<body>
  <h2>لعبة XO متعددة اللاعبين</h2>
  <div id="room-section">
    <form id="create-form">
      <input id="player-name" placeholder="اسمك" required>
      <input id="opponent-name" placeholder="اسم خصمك" required>
      <button>إنشاء غرفة</button>
    </form>
    <br>
    <form id="join-form">
      <input id="join-room-id" placeholder="معرف الغرفة" required>
      <input id="join-name" placeholder="اسمك" required>
      <button>انضم إلى غرفة</button>
    </form>
  </div>

  <div id="board-section">
    <div id="room-id-display"></div>
    <div id="status"></div>
    <div id="game-board"></div>
    <div>عدد انتصارات X: <span id="score-X">0</span> | O: <span id="score-O">0</span></div>
    <button onclick="location.reload()">مغادرة الغرفة</button>

    <div id="chat-box">
      <div id="messages"></div>
      <input id="chat-input" placeholder="أكتب رسالة...">
      <button onclick="sendMessage()">إرسال</button>
    </div>
  </div>
</body>
</html>
