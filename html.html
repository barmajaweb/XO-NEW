<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لعبة XO أونلاين</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCflw5LIGASb8ne8dXspJDwXQeubpmc0x4",
      authDomain: "xo-xo-d0335.firebaseapp.com",
      projectId: "xo-xo-d0335",
      storageBucket: "xo-xo-d0335.appspot.com",
      messagingSenderId: "526412538853",
      appId: "1:526412538853:web:32599656e9c8d6922cc50c",
      databaseURL: "https://xo-xo-d0335-default-rtdb.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomId = "";
    let player = "";
    let currentPlayer = "X";
    let scores = { X: 0, O: 0 };

    function createRoom() {
      roomId = Math.random().toString(36).substring(2, 8);
      player = "X";
      document.getElementById("room-id-display").textContent = "معرف الغرفة: " + roomId;
      set(ref(db, "rooms/" + roomId), {
        board: ["", "", "", "", "", "", "", "", ""],
        turn: "X",
        chat: [],
        scores: { X: 0, O: 0 }
      });
      showGame();
      listenToRoom();
    }

    function joinRoom() {
      roomId = document.getElementById("room-code").value.trim();
      if (roomId === "") return alert("يرجى إدخال معرف الغرفة!");
      player = "O";
      document.getElementById("room-id-display").textContent = "معرف الغرفة: " + roomId;
      showGame();
      listenToRoom();
    }

    function leaveRoom() {
      if (roomId) remove(ref(db, "rooms/" + roomId));
      location.reload();
    }

    function showGame() {
      document.getElementById("start").style.display = "none";
      document.getElementById("game").style.display = "block";
    }

    function listenToRoom() {
      onValue(ref(db, "rooms/" + roomId), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        updateBoard(data.board);
        currentPlayer = data.turn;
        scores = data.scores || { X: 0, O: 0 };
        updateScores();
        updateChat(data.chat || []);
      });
    }

    function play(index) {
      const cell = document.getElementById("cell" + index);
      if (cell.textContent !== "" || currentPlayer !== player) return;
      onValue(ref(db, "rooms/" + roomId), (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const board = data.board;
        if (board[index] === "") {
          board[index] = player;
          const winner = checkWinner(board);
          let newScores = data.scores || { X: 0, O: 0 };
          if (winner) {
            alert("الفائز هو: " + winner);
            newScores[winner]++;
            setTimeout(() => clearBoard(), 1000);
          } else if (!board.includes("")) {
            alert("تعادل!");
            setTimeout(() => clearBoard(), 1000);
          }
          set(ref(db, "rooms/" + roomId), {
            board,
            turn: player === "X" ? "O" : "X",
            chat: data.chat || [],
            scores: newScores
          });
        }
      }, { onlyOnce: true });
    }

    function clearBoard() {
      set(ref(db, "rooms/" + roomId + "/board"), ["", "", "", "", "", "", "", "", ""]);
    }

    function updateBoard(board) {
      board.forEach((val, i) => {
        document.getElementById("cell" + i).textContent = val;
      });
    }

    function updateScores() {
      document.getElementById("score-x").textContent = "X: " + (scores.X || 0);
      document.getElementById("score-o").textContent = "O: " + (scores.O || 0);
    }

    function checkWinner(b) {
      const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
      for (let [a, b1, c] of wins) {
        if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
      }
      return null;
    }

    function sendMessage() {
      const msg = document.getElementById("msg").value.trim();
      if (msg === "") return;
      onValue(ref(db, "rooms/" + roomId), (snapshot) => {
        const data = snapshot.val();
        const messages = data.chat || [];
        messages.push(player + ": " + msg);
        set(ref(db, "rooms/" + roomId + "/chat"), messages);
        document.getElementById("msg").value = "";
      }, { onlyOnce: true });
    }

    function updateChat(messages) {
      const chatBox = document.getElementById("chat-box");
      chatBox.innerHTML = "";
      messages.forEach(m => {
        const p = document.createElement("p");
        p.textContent = m;
        chatBox.appendChild(p);
      });
    }

    window.createRoom = createRoom;
    window.joinRoom = joinRoom;
    window.leaveRoom = leaveRoom;
    window.play = play;
    window.sendMessage = sendMessage;
  </script>

  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to bottom, #f9f9f9, #ddd);
      text-align: center;
      direction: rtl;
      padding: 20px;
    }
    #game { display: none; }
    .board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 5px;
      justify-content: center;
      margin: 20px auto;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 40px;
      background: #fff;
      border: 2px solid #888;
      cursor: pointer;
    }
    #chat-box {
      height: 150px;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #aaa;
      padding: 10px;
      margin-bottom: 10px;
    }
    input, button {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    #room-id-display {
      font-size: 20px;
      margin: 10px 0;
      color: #333;
    }
  </style>
</head>

<body>
  <div id="start">
    <h2>مرحباً بك في لعبة XO أونلاين</h2>
    <button onclick="createRoom()">إنشاء غرفة</button><br>
    <input type="text" id="room-code" placeholder="أدخل معرف الغرفة">
    <button onclick="joinRoom()">الانضمام إلى غرفة</button>
  </div>

  <div id="game">
    <h3 id="room-id-display"></h3>
    <div class="board">
      <div class="cell" id="cell0" onclick="play(0)"></div>
      <div class="cell" id="cell1" onclick="play(1)"></div>
      <div class="cell" id="cell2" onclick="play(2)"></div>
      <div class="cell" id="cell3" onclick="play(3)"></div>
      <div class="cell" id="cell4" onclick="play(4)"></div>
      <div class="cell" id="cell5" onclick="play(5)"></div>
      <div class="cell" id="cell6" onclick="play(6)"></div>
      <div class="cell" id="cell7" onclick="play(7)"></div>
      <div class="cell" id="cell8" onclick="play(8)"></div>
    </div>
    <div>
      <strong>النقاط:</strong>
      <span id="score-x">X: 0</span> |
      <span id="score-o">O: 0</span>
    </div>
    <div id="chat-box"></div>
    <input id="msg" placeholder="أدخل رسالة...">
    <button onclick="sendMessage()">إرسال</button><br><br>
    <button onclick="leaveRoom()">مغادرة الغرفة</button>
  </div>
</body>
</html>
