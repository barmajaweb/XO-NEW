<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ŸÑÿπÿ®ÿ© XO ÿ£ŸàŸÜŸÑÿßŸäŸÜ</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(to right, #f7f7f7, #e6f0ff);
      text-align: center;
      padding: 20px;
      direction: rtl;
    }
    .container {
      max-width: 500px;
      margin: auto;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
    }
    input, button {
      padding: 10px;
      width: 80%;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 10px;
      font-size: 16px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    .room-info {
      margin: 20px 0;
      font-size: 18px;
      color: #333;
    }
    #gameArea {
      display: none;
      margin-top: 20px;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 48px;
      background: #f0f0f0;
      border-radius: 15px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    .cell:hover {
      background-color: #d6eaff;
    }
    #scores {
      display: flex;
      justify-content: space-around;
      font-size: 20px;
      margin-bottom: 15px;
    }
    #chat {
      background: #f9f9f9;
      border-radius: 10px;
      border: 1px solid #ccc;
      height: 200px;
      overflow-y: auto;
      padding: 10px;
      text-align: right;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #chat input {
      width: calc(80% - 20px);
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
      direction: rtl;
    }
    #chat button {
      width: 18%;
      padding: 10px;
      font-size: 16px;
      border-radius: 10px;
      background-color: #2196F3;
      border: none;
      color: white;
      cursor: pointer;
      margin-left: 2%;
    }
    #chat button:hover {
      background-color: #1976d2;
    }
    #leaveBtn {
      background-color: #e74c3c;
      margin-top: 20px;
      width: 100%;
      border: none;
      font-size: 18px;
    }
    #leaveBtn:hover {
      background-color: #c0392b;
    }
    #turnInfo {
      margin-bottom: 15px;
      font-size: 18px;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>ŸÑÿπÿ®ÿ© XO ÿ£ŸàŸÜŸÑÿßŸäŸÜ</h2>

    <div id="mainMenu">
      <input type="text" id="playerName" placeholder="ÿßÿ≥ŸÖŸÉ" />
      <input type="text" id="opponentName" placeholder="ÿßÿ≥ŸÖ ÿÆÿµŸÖŸÉ" />
      <button onclick="createRoom()">ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©</button>

      <hr />

      <input type="text" id="roomCodeJoin" placeholder="ŸÖÿπÿ±ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ©" />
      <input type="text" id="joiningPlayerName" placeholder="ÿßÿ≥ŸÖŸÉ" />
      <button onclick="joinRoom()">ÿßŸÜÿ∂ŸÖÿßŸÖ ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ©</button>
    </div>

    <div id="roomInfo" class="room-info" style="display:none;"></div>

    <div id="gameArea">
      <div id="scores">
        <div>üèÜ <span id="player1Name"></span>: <span id="score1">0</span></div>
        <div>üèÜ <span id="player2Name"></span>: <span id="score2">0</span></div>
      </div>

      <div id="turnInfo"></div>

      <div id="board">
        <div class="cell" id="cell0" onclick="makeMove(0)"></div>
        <div class="cell" id="cell1" onclick="makeMove(1)"></div>
        <div class="cell" id="cell2" onclick="makeMove(2)"></div>
        <div class="cell" id="cell3" onclick="makeMove(3)"></div>
        <div class="cell" id="cell4" onclick="makeMove(4)"></div>
        <div class="cell" id="cell5" onclick="makeMove(5)"></div>
        <div class="cell" id="cell6" onclick="makeMove(6)"></div>
        <div class="cell" id="cell7" onclick="makeMove(7)"></div>
        <div class="cell" id="cell8" onclick="makeMove(8)"></div>
      </div>

      <div id="chat">
        <div id="chatBox"></div>
        <input id="chatInput" placeholder="ÿßŸÉÿ™ÿ® ÿ±ÿ≥ÿßŸÑÿ©..." />
        <button onclick="sendMessage()">ÿ•ÿ±ÿ≥ÿßŸÑ</button>
      </div>

      <button id="leaveBtn" onclick="leaveRoom()">ŸÖÿ∫ÿßÿØÿ±ÿ© ÿßŸÑÿ∫ÿ±ŸÅÿ©</button>
    </div>
  </div>

  <audio id="clickSound" src="https://www.soundjay.com/button/beep-07.wav"></audio>
  <audio id="winSound" src="https://www.soundjay.com/button/beep-06.wav"></audio>
  <audio id="loseSound" src="https://www.soundjay.com/button/beep-05.wav"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCflw5LIGASb8ne8dXspJDwXQeubpmc0x4",
      authDomain: "xo-xo-d0335.firebaseapp.com",
      databaseURL: "https://xo-xo-d0335-default-rtdb.firebaseio.com",
      projectId: "xo-xo-d0335",
      storageBucket: "xo-xo-d0335.appspot.com",
      messagingSenderId: "526412538853",
      appId: "1:526412538853:web:32599656e9c8d6922cc50c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let roomId = "";
    let playerSymbol = "";
    let playerName = "";
    let opponentName = "";
    let currentTurn = "X";

    const clickSound = document.getElementById("clickSound");
    const winSound = document.getElementById("winSound");
    const loseSound = document.getElementById("loseSound");

    // ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ© ÿ¨ÿØŸäÿØÿ©
    window.createRoom = () => {
      playerName = document.getElementById("playerName").value.trim();
      opponentName = document.getElementById("opponentName").value.trim();

      if (!playerName || !opponentName) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖŸÉ Ÿàÿßÿ≥ŸÖ ÿÆÿµŸÖŸÉ");
        return;
      }

      roomId = Math.random().toString(36).substring(2, 8);
      playerSymbol = "X";

      const roomRef = ref(db, "rooms/" + roomId);
      set(roomRef, {
        player1: { name: playerName, score: 0, symbol: "X" },
        player2: { name: opponentName, score: 0, symbol: "O" },
        board: ["", "", "", "", "", "", "", "", ""],
        turn: "X",
        chat: [],
        state: "waiting"
      });

      document.getElementById("roomInfo").innerText = `ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑÿ∫ÿ±ŸÅÿ©! ÿ¥ÿßÿ±ŸÉ Ÿáÿ∞ÿß ÿßŸÑŸÉŸàÿØ ŸÖÿπ ÿÆÿµŸÖŸÉ:\n${roomId}`;
      showGameArea();
      clickSound.play();
      updatePlayerNames();
      listenRoomUpdates();
    };

    // ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿ•ŸÑŸâ ÿ∫ÿ±ŸÅÿ© ŸÖŸàÿ¨ŸàÿØÿ©
    window.joinRoom = () => {
      roomId = document.getElementById("roomCodeJoin").value.trim();
      playerName = document.getElementById("joiningPlayerName").value.trim();

      if (!roomId || !playerName) {
        alert("Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿπÿ±ŸÅ ÿßŸÑÿ∫ÿ±ŸÅÿ© Ÿàÿßÿ≥ŸÖŸÉ");
        return;
      }

      const roomRef = ref(db, "rooms/" + roomId);
      onValue(roomRef, (snapshot) => {
        if (!snapshot.exists()) {
          alert("Ÿáÿ∞Ÿá ÿßŸÑÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©");
          return;
        }
        const data = snapshot.val();

        if (data.state === "started") {
          alert("ÿßŸÑŸÑÿπÿ®ÿ© ŸÇÿØ ÿ®ÿØÿ£ÿ™ ÿ®ÿßŸÑŸÅÿπŸÑ");
          return;
        }

        if (data.player2.name !== playerName) {
          // ÿ™ÿ≠ÿØŸäÿ´ ÿßÿ≥ŸÖ ÿßŸÑŸÑÿßÿπÿ® ÿßŸÑÿ´ÿßŸÜŸä
          update(roomRef, {
            player2: { name: playerName, score: data.player2.score, symbol: "O" },
            state: "started"
          });
        }

        playerSymbol = "O";
        opponentName = data.player1.name;

        document.getElementById("roomInfo").innerText = `ÿ™ŸÖ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ ÿ•ŸÑŸâ ÿßŸÑÿ∫ÿ±ŸÅÿ©: ${roomId}`;
        showGameArea();
        clickSound.play();
        updatePlayerNames();
        listenRoomUpdates();
      }, { onlyOnce: true });
    };

    function showGameArea() {
      document.getElementById("mainMenu").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      document.getElementById("leaveBtn").style.display = "block";
    }

    function updatePlayerNames() {
      document.getElementById("player1Name").textContent = playerName;
      document.getElementById("player2Name").textContent = opponentName;
    }

    function listenRoomUpdates() {
      const roomRef = ref(db, "rooms/" + roomId);
      onValue(roomRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        updateBoard(data.board);
        updateScores(data.player1.score, data.player2.score);
        currentTurn = data.turn;
        updateTurnInfo();

        updateChat(data.chat || []);

        if (data.state === "waiting") {
          document.getElementById("roomInfo").innerText = "ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÜÿ∂ŸÖÿßŸÖ ÿßŸÑÿÆÿµŸÖ...";
        } else if (data.state === "ended") {
          alert("ÿßŸÑŸÑÿπÿ®ÿ© ÿßŸÜÿ™Ÿáÿ™");
          winSound.play();
        }
      });
    }

    function updateBoard(board) {
      board.forEach((cell, i) => {
        document.getElementById("cell" + i).textContent = cell;
      });
    }

    function updateScores(score1, score2) {
      document.getElementById("score1").textContent = score1;
      document.getElementById("score2").textContent = score2;
    }

    function updateTurnInfo() {
      const turnText = currentTurn === playerSymbol ? "ÿØŸàÿ±ŸÉ ÿßŸÑÿ¢ŸÜ" : `ÿØŸàÿ± ÿßŸÑŸÑÿßÿπÿ® ${currentTurn}`;
      document.getElementById("turnInfo").textContent = turnText;
    }

    window.makeMove = (index) => {
      const cellRef = ref(db, `rooms/${roomId}/board/${index}`);
      if (currentTurn !== playerSymbol) return;
      if (document.getElementById("cell" + index).textContent !== "") return;

      clickSound.play();

      onValue(cellRef, (snapshot) => {
        if (snapshot.exists() && snapshot.val() === "") {
          const boardRef = ref(db, "rooms/" + roomId + "/board");
          onValue(ref(db, "rooms/" + roomId), (snap) => {
            let data = snap.val();
            if (!data) return;

            // ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÅŸàÿ≤ ÿ®ÿπÿØ ÿßŸÑÿ™ÿ≠ÿ±ŸÉ
            const board = data.board;
            board[index] = playerSymbol;

            const winner = checkWinner(board);
            let player1Score = data.player1.score;
            let player2Score = data.player2.score;
            let newTurn = playerSymbol === "X" ? "O" : "X";
            let newState = data.state;

            if (winner) {
              if (winner === playerSymbol) {
                alert("ŸÑŸÇÿØ ÿ±ÿ®ÿ≠ÿ™!");
                winSound.play();
                if (playerSymbol === "X") player1Score++; else player2Score++;
              } else {
                loseSound.play();
              }
              newState = "ended";
              // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÑŸàÿ≠ÿ© ÿ®ÿπÿØ ÿ´ÿßŸÜŸäÿ©
              setTimeout(() => resetBoard(), 1200);
            } else if (!board.includes("")) {
              alert("ÿ™ÿπÿßÿØŸÑ!");
              newState = "ended";
              setTimeout(() => resetBoard(), 1200);
            }

            set(ref(db, "rooms/" + roomId), {
              ...data,
              board,
              turn: newTurn,
              player1: { ...data.player1, score: player1Score },
              player2: { ...data.player2, score: player2Score },
              state: newState,
            });
          }, { onlyOnce: true });
        }
      }, { onlyOnce: true });
    };

    function checkWinner(board) {
      const lines = [
        [0,1,2],[3,4,5],[6,7,8],
        [0,3,6],[1,4,7],[2,5,8],
        [0,4,8],[2,4,6]
      ];
      for (const [a,b,c] of lines) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      return null;
    }

    function resetBoard() {
      set(ref(db, "rooms/" + roomId + "/board"), ["", "", "", "", "", "", "", "", ""]);
      updateTurnInfo();
      // ÿ•ÿπÿßÿØÿ© ÿ≠ÿßŸÑÿ© ÿßŸÑŸÑÿπÿ®ÿ© ŸÑŸÑÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿ∞ÿß ÿ™ÿ±ŸäÿØ (ÿ£Ÿà ÿßÿ≥ÿ™ŸÖÿ± ÿ≠ÿ≥ÿ® ÿßŸÑŸÖŸÜÿ∑ŸÇ)
      update(ref(db, "rooms/" + roomId), { state: "started" });
    }

    // ÿØÿ±ÿØÿ¥ÿ©
    window.sendMessage = () => {
      const input = document.getElementById("chatInput");
      const msg = input.value.trim();
      if (!msg) return;
      onValue(ref(db, "rooms/" + roomId), (snap) => {
        let data = snap.val();
        let chat = data.chat || [];
        chat.push({ from: playerName, text: msg });
        update(ref(db, "rooms/" + roomId), { chat });
        input.value = "";
      }, { onlyOnce: true });
    };

    function updateChat(chat) {
      const chatBox = document.getElementById("chatBox");
      chatBox.innerHTML = "";
      chat.forEach(({from, text}) => {
        const p = document.createElement("p");
        p.textContent = from + ": " + text;
        chatBox.appendChild(p);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    window.leaveRoom = () => {
      if (roomId) {
        remove(ref(db, "rooms/" + roomId));
      }
      location.reload();
    };
  </script>
</body>
</html>
